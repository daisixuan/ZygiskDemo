plugins {
    alias(libs.plugins.android.library)
}

android {
    namespace 'com.example.mysystemservice'
    compileSdk 34

    defaultConfig {
        minSdk 24
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        consumerProguardFiles "consumer-rules.pro"
    }

    buildTypes {
        debug {
            minifyEnabled false
            debuggable true
        }
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_11
        targetCompatibility JavaVersion.VERSION_11
    }

    buildFeatures {
        aidl true
    }
}

dependencies {
    implementation libs.appcompat
    implementation libs.material
}

// ä» AAR æ–‡ä»¶ç”Ÿæˆ DEXï¼Œç„¶åè½¬æ¢ä¸ºåŒ…å« DEX çš„ JAR
tasks.register('generateJarFromAAR') {
    description = 'Generate Android-compatible JAR file containing DEX from AAR'
    group = 'build'

    dependsOn 'assembleDebug'

    doLast {
        def aarFile = file("${layout.buildDirectory.get()}/outputs/aar").listFiles()?.find {
            it.name.endsWith('-debug.aar')
        }

        if (aarFile && aarFile.exists()) {
            def outputDir = file("${layout.buildDirectory.get()}/outputs/jar")
            outputDir.mkdirs()

            // ä» AAR ä¸­æå– classes.jar
            def tempDir = file("${outputDir}/temp")
            tempDir.mkdirs()

            copy {
                from zipTree(aarFile)
                into tempDir
                include 'classes.jar'
            }

            def classesJar = file("${tempDir}/classes.jar")
            if (classesJar.exists()) {
                println "ğŸ“¦ Found classes.jar: ${classesJar.absolutePath}"

                // åˆ›å»ºDEXè¾“å‡ºç›®å½•
                def dexDir = file("${tempDir}/dex")
                dexDir.mkdirs()

                // ä½¿ç”¨ d8 å°† JAR è½¬æ¢ä¸º DEX
                def d8Tool = "${android.sdkDirectory}/build-tools/${android.buildToolsVersion}/d8"
                if (System.getProperty('os.name').toLowerCase().contains('windows')) {
                    d8Tool += '.bat'
                }

                println "ğŸ”§ Using d8 tool: ${d8Tool}"
                println "ğŸ”„ Converting JAR to DEX..."

                try {
                    exec {
                        commandLine d8Tool,
                                '--output', dexDir.absolutePath,
                                '--min-api', android.defaultConfig.minSdk,
                                classesJar.absolutePath
                    }
                } catch (Exception e) {
                    throw new GradleException("âŒ Failed to convert JAR to DEX: ${e.message}")
                }

                // æ£€æŸ¥ç”Ÿæˆçš„ DEX æ–‡ä»¶
                def generatedDex = file("${dexDir}/classes.dex")
                if (!generatedDex.exists()) {
                    throw new GradleException("âŒ classes.dex file not generated")
                }

                println "âœ… DEX conversion successful"
                println "ğŸ“Š DEX file size: ${generatedDex.length()} bytes"

                // åˆ›å»ºåŒ…å« DEX çš„ JAR æ–‡ä»¶
                def targetJar = file("${outputDir}/mysystemservice.jar")

                println "ğŸ“¦ Creating JAR file with DEX content..."

                // ä½¿ç”¨ Ant çš„ zip ä»»åŠ¡åˆ›å»º JAR
                ant.zip(destfile: targetJar.absolutePath, level: 0) {
                    zipfileset(file: generatedDex.absolutePath, fullpath: "classes.dex")
                }

                // éªŒè¯ç”Ÿæˆçš„JARæ–‡ä»¶
                if (!targetJar.exists() || targetJar.length() == 0) {
                    throw new GradleException("âŒ Failed to create JAR file")
                }

                println "âœ… JAR file created successfully"

                // éªŒè¯JARå†…å®¹
                def jarContents = []
                zipTree(targetJar).visit { element ->
                    if (!element.isDirectory()) {
                        jarContents.add(element.relativePath.pathString)
                    }
                }

                if (jarContents.contains("classes.dex")) {
                    println "âœ… JAR contains classes.dex - Android compatible format"
                } else {
                    throw new GradleException("âŒ JAR does not contain classes.dex")
                }

                // åˆ›å»ºæ ¹ç›®å½•çš„ Jar æ–‡ä»¶å¤¹å¹¶ç§»åŠ¨æ–‡ä»¶
                def rootJarDir = file("${rootProject.projectDir}/Jar")
                rootJarDir.mkdirs()

                def finalJarFile = file("${rootJarDir}/mysystemservice.jar")
                copy {
                    from targetJar
                    into rootJarDir
                }

                // åŒæ—¶ä¿ç•™DEXæ–‡ä»¶åˆ°Dexç›®å½•ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
                def rootDexDir = file("${rootProject.projectDir}/Dex")
                rootDexDir.mkdirs()

                def finalDexFile = file("${rootDexDir}/mysystemservice.dex")
                copy {
                    from generatedDex
                    into rootDexDir
                    rename 'classes.dex', 'mysystemservice.dex'
                }

                println ""
                println "ğŸ¯ Build completed successfully!"
                println "ğŸ“ Android JAR: ${finalJarFile.absolutePath}"
                println "ğŸ“ DEX file: ${finalDexFile.absolutePath}"
                println "ğŸ“Š JAR size: ${finalJarFile.length()} bytes"
                println "ğŸ“Š DEX size: ${finalDexFile.length()} bytes"
                println ""
                println "âœ… Ready for Magisk module deployment:"
                println "   Copy ${finalJarFile.name} to /system/framework/"

            } else {
                throw new GradleException("âŒ classes.jar not found in AAR")
            }

            // æ¸…ç†ä¸´æ—¶ç›®å½•
            delete tempDir

        } else {
            throw new GradleException("âŒ AAR file not found in ${file("${layout.buildDirectory.get()}/outputs/aar").absolutePath}")
        }
    }
}

// æ¸…ç†ä»»åŠ¡
tasks.register('cleanJar') {
    description = 'Clean generated JAR and DEX files'
    group = 'build'

    doLast {
        delete "${layout.buildDirectory.get()}/outputs/jar"
        delete "${layout.buildDirectory.get()}/outputs/dex"
        delete "${rootProject.projectDir}/Jar"
        delete "${rootProject.projectDir}/Dex"
        println "ğŸ§¹ Cleaned JAR and DEX files from build and root directories"
    }
}

// éªŒè¯JARæ–‡ä»¶ä»»åŠ¡
tasks.register('verifyJar') {
    description = 'Verify the generated JAR file format and content'
    group = 'build'

    doLast {
        def jarFile = file("${rootProject.projectDir}/Jar/mysystemservice.jar")
        if (!jarFile.exists()) {
            println "âŒ JAR file not found: ${jarFile.absolutePath}"
            return
        }

        println "ğŸ” Verifying JAR file: ${jarFile.name}"
        println "ğŸ“Š File size: ${jarFile.length()} bytes"

        // æ£€æŸ¥JARå†…å®¹
        def jarContents = []
        zipTree(jarFile).visit { element ->
            if (!element.isDirectory()) {
                jarContents.add(element.relativePath.pathString)
                println "ğŸ“„ Contains: ${element.relativePath.pathString}"
            }
        }

        if (jarContents.contains("classes.dex")) {
            println "âœ… JAR is Android-compatible (contains classes.dex)"
        } else {
            println "âŒ JAR is NOT Android-compatible"
            println "ğŸ“‹ Expected: classes.dex"
            println "ğŸ“‹ Found: ${jarContents}"
        }

        // å¦‚æœæœ‰dexdumpå·¥å…·ï¼Œè¿›è¡Œè¯¦ç»†éªŒè¯
        def dexFile = file("${rootProject.projectDir}/Dex/mysystemservice.dex")
        if (dexFile.exists()) {
            println ""
            println "ğŸ” DEX file analysis:"
            println "ğŸ“Š DEX size: ${dexFile.length()} bytes"

            try {
                def dexdumpCmd = ["dexdump", "-f", dexFile.absolutePath]
                def process = dexdumpCmd.execute()
                process.waitFor()
                if (process.exitValue() == 0) {
                    def output = process.inputStream.text
                    if (output.contains("ServiceInjector")) {
                        println "âœ… ServiceInjector class found in DEX"
                    } else {
                        println "âš ï¸  ServiceInjector class not found in DEX output"
                    }
                } else {
                    println "âš ï¸  dexdump execution failed"
                }
            } catch (Exception e) {
                println "â„¹ï¸  dexdump not available for detailed verification"
            }
        }

        println ""
        println "ğŸ“‹ Deployment instructions:"
        println "   1. Push JAR to device: adb push ${jarFile.name} /system/framework/"
        println "   2. Set permissions: adb shell chmod 644 /system/framework/${jarFile.name}"
        println "   3. Restart system_server or reboot device"
    }
}

// ä¸€é”®æ„å»º JAR åˆ°æ ¹ç›®å½•
tasks.register('buildJar') {
    description = 'Clean, build and generate Android-compatible JAR file'
    group = 'build'

    dependsOn 'cleanJar', 'generateJarFromAAR'

    // ç¡®ä¿æ¸…ç†åœ¨ç”Ÿæˆä¹‹å‰æ‰§è¡Œ
    generateJarFromAAR.mustRunAfter cleanJar

    finalizedBy 'verifyJar'
}

// å…¼å®¹æ—§çš„ä»»åŠ¡å
tasks.register('buildDex') {
    description = 'Alias for buildJar (backward compatibility)'
    group = 'build'
    dependsOn 'buildJar'
}